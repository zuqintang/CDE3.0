<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>编辑器3.0</title>
	<link href="./libs/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css">
	<link href="./libs/plugins/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
	<link href="./libs/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css" rel="stylesheet">
	<link href="./libs/plugins/bootstrap-modal/css/bootstrap-modal.css" rel=" stylesheet">
	<link href="./libs/plugins/bootstrap-toastr/toastr.min.css" rel=" stylesheet">
	<link href="./libs/bootstrap.css" rel="stylesheet">
	<link href="./libs/bootstrap-table.css" rel="stylesheet">
	<link href="./libs/select2.css" rel="stylesheet">
	<link href="./libs/plugins/animate.css" rel="stylesheet">
	<link href="./libs/editor.css" rel="stylesheet">
	<link href="./libs/slider.css" rel="stylesheet" type="text/css" />
	<script src="./libs/jquery-1.12.4.js"></script>
	<script src="./libs/bootstrap-3.3.7.js"></script>
	<script src="./libs/bootstrap-paginator.js"></script>
	<script src="./libs/plugins/sweetalert/sweetalert.min.js"></script>
	<script src="./libs/plugins/bootstrap-toastr/toastr.min.js"></script>
	<script src="./libs/select2.js"></script>
	<script src="./libs/plugins/bootstrap-table/bootstrap-table.min.js"></script>
	<script src="./libs/plugins/bootstrap-table/bootstrap-table-zh-CN.min.js"></script>
	<script src="./libs/editor.js"></script>
	<script src='./libs/vue.js' type='text/javascript'></script>
	<script src='./libs/vue-resource.js' type='text/javascript'></script>
</head>
<body style="background: #eff3f8;">
<div class="cde-header">
		<div class="cde-logo">
			<a href="#/">
				<img src="images/logo.jpg" alt="logo" class="logo-default">
			</a>
		</div>
		<div class="cde-menu dropdown">
			<div class="userInfo dropdown-toggle hover-initialized" data-toggle="dropdown" data-hover="dropdown" data-close-others="true" aria-expanded="true">
				<i class="icon-user"></i>
				<span ></span>
			</div>
			<ul class="dropdown-menu dropdown-menu-default">
				<a href="javascript:;" class="white-triangle"></a>
				<li class="special-li">
					<a href="users.html" target="_blank">
						<i class="icon-users"></i> 用户管理
					</a>
				</li>
				<li>
					<a href="eles_manage.html" target="_blank">
						<i class="icon-book-open"></i> 数据元维护
					</a>
				</li>
				<li>
					<a href="formulas_manage.html" target="_blank">
						<i class="icon-calculator"></i> 公式维护
					</a>
				</li>
				<li>
					<a href="javascript:" onclick="signOut();">
						<i class="icon-logout"></i> 注销
					</a>
				</li>
			</ul>
		</div>
</div>
<div class="cde-content">
	<!--<div class="subject-Menu">
		<a class="menu-dropdown" href="javascript:;"> IgA肾病新的病理分型与临床对应性研究</a>
		<ul class="dropdown-menu-subject">
			<li><a href=""> IgA肾病新的病理分型与临床对应性研究</a></li>
			<li><a href="">肥厚型非梗阻性心肌病</a></li>
		</ul>
	</div>-->
	<div class="ctrlWarpper">
		<div class="search-wrapper" style="margin:10px 0px">
			<div class="col-sm-8">
				<span class="create_sbj_btn btn_hover inline-block" role="button" onclick="addTemplate()"><i class="glyphicon glyphicon-plus"></i>&nbsp;创建模板</span>
			</div>
			<div class="col-sm-2" style="padding-right: 10px;">
				<select id="gridID" class="form-control createTree" onchange="refreshData();"></select>
			</div>
			<div class="col-sm-2 position-relative">
				<input type="text" id="keySearch" class="form-control form-control-special" placeholder="CRF检索" style="padding-right: 26px;" oninput="refreshData();"/>
			<span class="position-absolute" style="display:inline-block; right:10px; top:6px; cursor:pointer;">
				<i class="icon-magnifier" style="color:#c3c5c9; font-size:15px;"></i>
			</span>
			</div>
			<div class="clearfix"></div>
		</div>
		<table id="testTable" style="background:#fff;"></table>
	</div>
</div>
<div class="cde-footer">
	<div class="container-fluid ng-scope">
		2017 © <a href="http://www.goodwillcis.com/" title="北京嘉和美康信息技术有限公司 | 科研事业部" target="_blank">北京嘉和美康信息技术有限公司 | 科研事业部</a>
	</div>
</div>
<div class="modal-wrapper" id="tplM">
	<div id="TempInfoModal" class="modal fade container modal-overflow" tabindex="-1" role="dialog" data-backdrop="static"
		 data-keyboard="false" data-attention-animation="false" style="padding-right:0px!important;">
		<div class="flex-wrapper">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
				<h5 class="modal-title">模板详细</h5>
			</div>
			<div class="modal-body">
				<section class="animated siteMod">
					<div class="temp-content" style="padding: 20px;">
					<div class="col-sm-12">
						<div class="col-sm-6 temp-content-node">
							<div class="col-sm-2 temp-content-title">模板名称</div>
							<div class="col-sm-9 temp-content-input">
								<input type="text" class="form-control check-div" v-model="dataM.NAME"/>
								<div class="vaildtips">
									<span class="vaildtip2">模板名称不能为空</span>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-6 temp-content-node">
						<div class="col-sm-2 temp-content-title">课题简称</div>
						<div class="col-sm-9 temp-content-input">
							<select class="form-control subjectSelect check-div" v-model="dataM.SUBJECT_ID" onchange="subjChange();">
								<option value="">--请选择--</option>
								<option v-for="(item,index) in subjectM":value="item.SUBJECT_ID" :key="index">{{item.SUBJECT_NAME}}</option>
							</select>
							<div class="vaildtips">
								<span class="vaildtip2">课题简称不能为空</span>
							</div>
						</div>
					</div>
					<div class="col-sm-6 temp-content-node">
						<div class="col-sm-2 temp-content-title">申请机构</div>
						<div class="col-sm-9 temp-content-input">
							<select class="form-control agencySelect check-div" disabled="disabled">
								<option value="">--请选择--</option>
								<option v-for="(item,index) in subjectM":value="item.SUBJECT_ID" :key="index">{{item.AGENCY_NAME}}</option>
							</select>
							<div class="vaildtips">
								<span class="vaildtip2">申请机构不能为空</span>
							</div>
						</div>
					</div>
					<div class="col-sm-6 temp-content-node">
						<div class="col-sm-2 temp-content-title">模板样式</div>
						<div class="col-sm-9 temp-content-input">
							<select class="form-control" v-model="dataM.STYLE_PADDING">
								<option value="moderate" selected="slected">适中布局</option>
								<option value="moderate-bold">适中布局标题加粗</option>
								<option value="compact">紧凑布局</option>
								<option value="compact-bold">紧凑布局标题加粗</option>
							</select>
						</div>
					</div>
					<div class="col-sm-6 temp-content-node">
						<div class="col-sm-2 temp-content-title">模板色调</div>
						<div class="col-sm-9 temp-content-input">
							<select class="form-control" v-model="dataM.STYLE_COLOR">
								<option value="blue" selected="selected">蓝色调</option>
							</select>
						</div>
					</div>
				</div>
				</section>
			</div>
			<div class="modal-footer">
				<button type="button" data-dismiss="modal" class="btn btn-sm btn-outline blue-dark">关闭</button>
				<button type="button" onclick="saveTemplate();" class="btn btn-sm blue">保存</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
$(document).ready(function () {
	 tplM = new Vue({
		el : '#tplM',
		data : {
			dataM: {ID: $('#ID'), NAME:'', STYLE_PADDING:'moderate', STYLE_COLOR:'blue', CREATE_MAN: '', SUBJECT_ID: $('#gridID').val()},
			subjectM : []
		}
	 });

	$('#testTable').bootstrapTable({
		url: apiURL+'/CRFSvr/newAllTemplates',
		method: 'post',
		contentType: "application/x-www-form-urlencoded",
		striped: true,
		cache: true,
		iconSize: 'xs',
		pageNumber: 1,
		pageSize: 10,
		pageList: [5, 10, 15, 20, 'ALL'],
		uniqueId: "ID",
		pagination: true,
		queryParamsType: 'limit',
		sidePagination: "server",
		queryParams: function (params) {
			return {
				SUBJECT_ID: $('#gridID').val(),
				keyword: $('#keySearch').val(),
				p: (params.offset / params.limit) + 1,
				pagesize: params.limit,
				sorter: 'id',
				desc: 'desc'
			}
		},
		paginationFirstText : "&laquo;",
		paginationPreText : "&lsaquo;",
		paginationNextText : "&rsaquo;",
		paginationLastText : "&raquo;",
		formatLoadingMessage: function () {
			return "数据加载中...";
		},
		formatNoMatches: function () {
			return '无符合条件的记录';
		},
		columns: [
			{
				field: 'SUBJECT_NAME',
				title: '课题简称',
				align: 'center'
			},
			{
				field: 'NAME',
				title: '模板名称',
				align: 'center',
				sortable: true
			},
			{
				field: 'AGENCY_NAME',
				title: '申办机构',
				align: 'center'
			},
			{
				field: 'VERSION_DATE',
				title: '创建时间',
				align: 'center',
				sortable: true
			},
			{
				field: 'CREATE_MAN',
				title: '创建人员',
				align: 'center'
			},
			{
				field: 'SUBJECT_ID',
				title: '操作',
				align: 'center',
				formatter: function (value, row, index) {
					return '<a data-id="' + row['ID'] + '"><i onclick="addTemplate('+ row['ID'] +')" class="icon icon_hover icon-settings" role="button" data-toggle="tooltip" data-placement="top" title="配置"></i></a>' +
							'<a class="preview-edit" href="./preview.html?id=' + row['ID'] +'" data-id="' + row['ID'] + '" target="_blank"><i class="icon icon_hover icon-magnifier-add" role="button" data-toggle="tooltip" data-placement="top" title="查看模板"></i></a>' +
							'<a class="preview-view" href="./preview_lable.html?id=' + row['ID'] +'" data-id="' + row['ID'] + '" target="_blank"><i class="icon icon_hover icon-magnifier-remove" role="button" data-toggle="tooltip" data-placement="top" title="查看数据"></i></a>' +
							'<a class="edit-template" href="./editor.html?id=' + row['ID'] +'" data-id="' + row['ID'] + '" target="_blank"><i class="icon icon_hover icon-note" role="button" data-toggle="tooltip" data-placement="top" title="编辑"></i></a>' +
							'<a class="remove-that" data-id="' + row['ID'] + '"><i class="icon icon_hover icon-trash" role="button" data-toggle="tooltip" data-placement="top" title="删除"></i></a>'
				},
				events: 'operateEvents'
			}
		],
		onLoadSuccess: function () {
			$('[data-toggle="tooltip"]').tooltip();
			$('.remove-that').on('click', function () {
				var ids = [$(this).attr('data-id')];
				swal({
					title: "确定删除该模板吗?",
					text: "",
					type: "warning"
				},function (isConfirm) {
					if (isConfirm) {
						$.post(apiURL+"/CRFSvr/delete", {ids: ids},
						function(res){
							if(res.code == 0){
								$('#testTable').bootstrapTable('refresh');
								toastr.success('所选模板已被删除!');
							}else{
								toastr.error('所选模板删除异常!');
							}
						},"json").error(function(res){console.log(res.responseText)});
					}
				});
			});
		}
	});
	$('.userInfo span').append(localStorage.r_username)
	getTplSelect2();
	$('#TempInfoModal').css('height','60%');
});
function getTplSelect2(){
	$.post(apiURL+'/CRFSvr/getSelectTpls', function(res){
		if (res.code == 0) {
			tplM.subjectM = res.data;
			var selectData = [];
			selectData.push({id:0, text:'项目检索'});
			for (var i = 0; i < res.data.length; i++){
				var row = res.data[i];
				selectData.push({id:row.SUBJECT_ID, text:row.SUBJECT_NAME});
			}
			$('#gridID').select2({data :selectData, templateResult : formatState, templateSelection : formatState});
		}
	}, "json");
}

function refreshData(){
	$('#testTable').bootstrapTable('refreshOptions', {pageNumber: 1});
	$('#testTable').bootstrapTable('refresh');
}

function addTemplate(tempID){
	if(tempID){
		$.post(apiURL+'/CRFSvr/newAllTemplates',{ID: tempID}, function(res){
			if (res.total > 0){
				tplM.dataM = res.rows[0];
				tplM.$nextTick(function () {
					subjChange();
				});
			}
		}, "json");
		$('#TempInfoModal section.siteMod').show().removeClass('fadeInLeft');
		$('#TempInfoModal section.siteMod').show().removeClass('fadeInRight');
		$('#TempInfoModal section.siteMod').show().addClass('fadeInRight');
	}else{
		tplM.dataM = {ID:'', NAME:'', STYLE_PADDING:'moderate', STYLE_COLOR:'blue', CREATE_MAN: '', SUBJECT_ID: ''};
		$('.agencySelect').val('');
		$('#TempInfoModal section.siteMod').show().removeClass('fadeInRight');
		$('#TempInfoModal section.siteMod').show().removeClass('fadeInLeft');
		$('#TempInfoModal section.siteMod').show().addClass('fadeInLeft');
	}
	$('.temp-content-node').removeClass('error2');
	$('#TempInfoModal').modal('show');
}

function saveTemplate(){
	var ajaxM = {ID:tplM.dataM.ID, NAME:tplM.dataM.NAME, STYLE_PADDING:tplM.dataM.STYLE_PADDING, STYLE_COLOR:tplM.dataM.STYLE_COLOR, CREATE_MAN: localStorage.r_username, SUBJECT_ID: tplM.dataM.SUBJECT_ID};
	if(tplM.dataM.ID == '') delete ajaxM['ID'];
	var sjaxTrue = 'Y';
	$('#TempInfoModal .check-div').each(function (index, ele) {
		if ($(this).val().trim().length == 0) {
			$(this).parents('.temp-content-node:first').addClass('error2');
			sjaxTrue = 'N';
		}
	});
	if(sjaxTrue = 'Y'){
		$.post(apiURL+'/CRFSvr/newInsertOrUpdate',ajaxM, function(res){
			if (res.code != 0) return false;
			$('#testTable').bootstrapTable('refresh');
			$('#TempInfoModal').modal('hide');
		}, "json");
	}
}

function subjChange(){
	$('.agencySelect').val($('.subjectSelect').val());
}

function signOut(){
	delete  localStorage.r_username;
	delete  localStorage.u_username;
	location = "login.html";
}
</script>
<style>
a{
	color: #1b2537;
}
.select2-container--default .select2-selection--single {
	height: 28px;
}
.form-control {
	font-size: 12px;
	height: 30px;
}
</style>
</body>
</html>
